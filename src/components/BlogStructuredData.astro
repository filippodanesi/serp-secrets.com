---
import type { CollectionEntry } from 'astro:content';
import siteConfig from '../data/site-config';

type Props = CollectionEntry<'blog'>['data'] & { body?: string };

const { title, excerpt, publishDate, updatedDate, image, tags, seo, body, isFeatured } = Astro.props;

const pageUrl = new URL(Astro.url.pathname, Astro.site);

const getArticleSection = (tags: string[]) => {
   if (!tags.length) return 'Blog';
   const primaryTag = tags[0];
   return /^[A-Z]/.test(primaryTag) ? primaryTag : primaryTag.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
};

const getWordCount = (content: string) => {
   return content.replace(/\s+/g, ' ').replace(/[^\w\s]/g, '').trim().split(' ').filter(word => word.length > 0).length;
};

const personInfo = {
    '@type': 'Person',
    '@id': `${Astro.site}#identity`,
    'name': 'Filippo Danesi',
    'url': Astro.site?.toString(),
    'sameAs': siteConfig.socialLinks?.map(link => link.href) || [],
    'image': {
        '@type': 'ImageObject',
        '@id': `${Astro.site}og-image.webp`,
        'url': `${Astro.site}og-image.webp`,
        'width': '1200',
        'height': '630'
    }
};

const wordCount = body ? getWordCount(body) : 0;

// Create breadcrumb list schema
const breadcrumbList = {
    '@type': 'BreadcrumbList',
    '@id': `${pageUrl.toString()}#breadcrumb`,
    'itemListElement': [
        {
            '@type': 'ListItem',
            'position': 1,
            'name': siteConfig.headerNavLinks?.find(link => link.href === '/')?.text || 'Home',
            'item': Astro.site?.toString()
        },
        {
            '@type': 'ListItem',
            'position': 2,
            'name': siteConfig.headerNavLinks?.find(link => link.href === '/blog/')?.text || 'Archive',
            'item': `${Astro.site}blog/`
        }
    ]
};

// Add category to breadcrumb if tags exist
if (tags.length > 0) {
    const categorySlug = tags[0].toLowerCase().replace(/\s+/g, '-');
    const categoryName = getArticleSection([tags[0]]);
    
    breadcrumbList.itemListElement.push({
        '@type': 'ListItem',
        'position': 3,
        'name': categoryName,
        'item': `${Astro.site}categories/${categorySlug}/`
    });
    
    // Adjust current page position
    breadcrumbList.itemListElement.push({
        '@type': 'ListItem',
        'position': 4,
        'name': title,
        'item': pageUrl.toString()
    });
} else {
    // If no category, current page is position 3
    breadcrumbList.itemListElement.push({
        '@type': 'ListItem',
        'position': 3,
        'name': title,
        'item': pageUrl.toString()
    });
}

const structuredData = [
    {
        '@context': 'https://schema.org',
        '@type': 'BlogPosting',
        '@id': `${pageUrl.toString()}#BlogPosting`,
        'mainEntityOfPage': {
            '@type': 'WebPage',
            '@id': pageUrl.toString()
        },
        'headline': title,
        'name': title,
        'description': excerpt || seo?.description || siteConfig.description,
        'datePublished': publishDate.toISOString(),
        'dateModified': updatedDate?.toISOString() || publishDate.toISOString(),
        'url': pageUrl.toString(),
        'isPartOf': {
            '@type': 'Blog',
            '@id': `${Astro.site}blog/`,
            'name': siteConfig.title,
            'publisher': personInfo
        },
        'image': image ? {
            '@type': 'ImageObject',
            '@id': `${Astro.site}${image.src.replace('/', '')}`,
            'url': `${Astro.site}${image.src.replace('/', '')}`,
            'caption': image.alt || '',
            'width': '1200',
            'height': '630'
        } : {
            '@type': 'ImageObject',
            '@id': `${Astro.site}${siteConfig.image.src.replace('/', '')}`,
            'url': `${Astro.site}${siteConfig.image.src.replace('/', '')}`,
            'caption': siteConfig.image.alt || '',
            'width': '1200',
            'height': '630'
        },
        'author': personInfo,
        'publisher': personInfo,
        'inLanguage': 'en',
        'keywords': tags.join(', '),
        'articleSection': getArticleSection(tags),
        'wordCount': wordCount,
        'isAccessibleForFree': 'http://schema.org/True',
        'copyrightYear': new Date(publishDate).getFullYear(),
        'copyrightHolder': personInfo,
        'isFeatured': isFeatured
    },
    breadcrumbList
];

if (tags.length) {
    const normalizedTag = tags[0].toLowerCase().replace(/\s+/g, '-');
    if (siteConfig.tagDescriptions[normalizedTag]) {
        structuredData[0].about = {
            '@type': 'Thing',
            'name': getArticleSection([tags[0]]),
            'description': siteConfig.tagDescriptions[normalizedTag]
        };
    }
}
---

<script type="application/ld+json" set:html={JSON.stringify(structuredData)} />